<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>shape-2-flat Demo</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		#dropzone {
			border: 2px dashed #888;
			border-radius: 6px;
			padding: 1.2rem;
			text-align: center;
			color: #555;
			cursor: pointer;
			transition: .2s background;
		}

		#dropzone.dragover {
			background: #f0f8ff;
		}

		#preview svg {
			width: 100%;
			height: auto;
			border: 1px solid #ddd;
			background: #fff;
		}

		.code-field {
			font-family: monospace;
		}
	</style>
</head>

<body class="container py-3">
	<h1 class="h4 mb-3">shape-2-flat Browser Demo</h1>

	<div class="row g-3">
		<div class="col-12 col-lg-6">
			<div id="dropzone">Drag & Drop SVG file here<br><small>or click to select</small></div>
			<input type="file" id="fileInput" accept=".svg,image/svg+xml" hidden>
			<div class="mt-3">
				<label class="form-label">Paste path d:</label>
				<textarea id="pathData" rows="4" class="form-control code-field"
					placeholder="M0,0 L100,0 L100,50 L0,50 Z"></textarea>
			</div>
			<div class="mt-3 row g-2">
				<div class="col-4">
					<label class="form-label">Depth (mm)</label>
					<input type="number" id="depth" class="form-control" value="40" min="1">
				</div>
				<div class="col-4">
					<label class="form-label">Tolerance</label>
					<input type="number" id="tolerance" class="form-control" value="0.5" step="0.1" min="0.05">
				</div>
				<div class="col-4">
					<label class="form-label">Min segment</label>
					<input type="number" id="minSegment" class="form-control" value="0.5" step="0.1" min="0">
				</div>
			</div>
			<div class="mt-3 d-flex gap-2">
				<button id="btnGenerate" class="btn btn-primary">Generate</button>
				<button id="btnDownload" class="btn btn-secondary" disabled>Download SVG</button>
				<button id="btnCopy" class="btn btn-outline-secondary" disabled>Copy SVG</button>
			</div>
			<div id="status" class="mt-3 small text-muted"></div>
		</div>
		<div class="col-12 col-lg-6">
			<h2 class="h6">Preview</h2>
			<div id="preview"></div>
		</div>
	</div>

	<script type="module">
		import "../src/core.mjs"; // attaches window.Shape2Flat

		const dz = document.getElementById('dropzone');
		const fileInput = document.getElementById('fileInput');
		const pathTA = document.getElementById('pathData');
		const depthEl = document.getElementById('depth');
		const tolEl = document.getElementById('tolerance');
		const minSegEl = document.getElementById('minSegment');
		const btnGen = document.getElementById('btnGenerate');
		const btnDl = document.getElementById('btnDownload');
		const btnCopy = document.getElementById('btnCopy');
		const preview = document.getElementById('preview');
		const statusEl = document.getElementById('status');

		let svgContent = null;

		dz.addEventListener('click', () => fileInput.click());
		dz.addEventListener('dragover', e => {
			e.preventDefault();
			dz.classList.add('dragover');
		});
		dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
		dz.addEventListener('drop', e => {
			e.preventDefault();
			dz.classList.remove('dragover');
			const f = e.dataTransfer.files[0];
			if (f) readFile(f);
		});

		fileInput.addEventListener('change', e => {
			const f = e.target.files[0];
			if (f) readFile(f);
		});

		function readFile(f) {
			const reader = new FileReader();
			reader.onload = ev => {
				svgContent = ev.target.result;
				statusEl.textContent = `Loaded file: ${f.name}`;
			};
			reader.readAsText(f);
		}

		btnGen.addEventListener('click', () => {
			try {
				const pathData = pathTA.value.trim() || null;
				if (!svgContent && !pathData) {
					statusEl.textContent = 'Provide SVG file or path data.';
					return;
				}
				const depth = parseFloat(depthEl.value) || 40;
				const tolerance = parseFloat(tolEl.value) || 0.5;
				const minSegment = parseFloat(minSegEl.value) || 0;
				const { generateNet } = window.Shape2Flat;

				const { svg, meta } = generateNet({
					svgContent,
					pathData,
					depth,
					tolerance,
					minSegment,
					unit: 'mm',
				});

				preview.innerHTML = svg;
				statusEl.textContent = `Perimeter: ${meta.perimeter.toFixed(2)} mm`;
				btnDl.disabled = false;
				btnCopy.disabled = false;

			} catch (err) {
				statusEl.textContent = 'Error: ' + err.message;
			}
		});

		btnDl.addEventListener('click', () => {
			const svgNode = preview.querySelector('svg');
			if (!svgNode) return;
			const blob = new Blob([svgNode.outerHTML], { type: 'image/svg+xml' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = 'net.svg';
			document.body.appendChild(a);
			a.click();
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		});

		btnCopy.addEventListener('click', async () => {
			const svgNode = preview.querySelector('svg');
			if (!svgNode) return;
			const text = svgNode.outerHTML;
			try {
				await navigator.clipboard.writeText(text);
				statusEl.textContent = 'SVG copied to clipboard.';
			} catch {
				statusEl.textContent = 'Clipboard copy failed.';
			}
		});
	</script>
</body>

</html>
